<%= f.text_field :customer_id %>

<div class="row equal-height">
  <div class="col-md-8 col-sm-12">
    <div class="row">
      <div class="col card border-white">
        <div class="card-header">
          <%= label_tag :customer %>
        </div>
        <div class="card-body text-primary" id="customer_table">
          <div class="input-group customer_autocomplete">
            <%= autocomplete_field_tag 'name', 
                (Customer.find(@order.customer_id).actual_name if !@order.customer_id.blank?), 
                autocomplete_customer_retail_activity_index_path, 
                placeholder: 'Search Customer', 
                id: 'retail_customer_search', 
                readonly: !@order.customer_id.blank?,
                class: 'form-control'
            %>
            <div class="input-group-append">
              <span class="input-group-text" id="basic-addon1">
                <% if @order.xero_invoice_id.nil? && user_full_right %>
                  <i class="far fa-trash-alt remove" title="remove"></i>
                <% else %>
                  &nbsp;
                <% end %>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="col card border-white">
        <div class="card-header">
          <%= label_tag :product %>
        </div>
        <div class="card-body text-primary">
          <%= autocomplete_field_tag 'product', '', 
              autocomplete_product_retail_activity_index_path, 
              placeholder: 'Search Retail Wines', 
              id_element: '#product_id', id: 'retail_product_search',
              class: 'form-control'
          %>
        </div>
      </div>
    </div>

    <%= render 'partials/order_address_form', f: f %>
  </div>
  <div class="col-md-4 col-sm-12">
    <div class="col card border-primary mb-3">
      <div class="card-header">
        <%= label_tag :last_ordered_products %>
      </div>
      <div class="card-body text-secondary scrollable">
        <% unless @order.customer_id.nil? || @order.customer_id == ""%>
          <ul>
            <%Product.where(id: OrderProduct.where("order_id IN (?) AND created_at > ?", 
              @order.customer.orders.map(&:id), (Date.today - 3.month).to_s(:db))
              .map(&:product_id)).each do |product| %>
                <li class="last-order-product-retail" 
                  product-id="<%= product.id %>"
                  name="<%= product.name%>"
                  inventory="<%= product.inventory %>"
                  price="<%= product.calculated_price * 1.29 %>" >
                  <%= product.name %>
                </li>
            <% end %>
          </ul>
        <% end %>
      </div>
    </div>
  </div>
</div>

<table class = "table table-striped table-bordered table-hover table-responsive product-table w-100 d-block d-table">
  <thead>
    <tr>
      <th>Product ID</th>
      <th>Product</th>
      <th style="width: 3px;">Inventory</th>
      <th style="min-width: 125px">Price</th>
      <th style="min-width: 90px">QTY</th>
      <th style="min-width: 150px">Discount</th>
      <th>Discounted Price</th>
      <th style="min-width: 180px;">Total</th>
    </tr>
  </thead>
  <tbody class="product-list">
    <% f.object.order_products.each do |product| %>
      <%= f.fields_for "products[#{product.product_id}]", product do |product_form|%>

    <tr id="tr_<%= product.product_id%>">
      <td><%= product_form.text_field :product_id, readonly: true, class: 'product_id form-control' %></td>
      <td><%= Product.find(product.product_id).name %></td>
      <td class="product-inventory"><%= Product.find(product.product_id).inventory %></td>
      <td><%= product_form.text_field :price_luc, readonly: true, class: 'product-luc form-control' %></td>
      <td><%= product_form.text_field :qty, class: 'product-qty form-control' %></td>
      <td>
        <div class="input-group">
          <%= product_form.text_field :discount, size: "2", class: 'product-discount form-control' %>
          <div class="input-group-append">
            <span class="input-group-text" id="basic-addon1">%</span>
          </div>
        </div>
      </td>
      <td><%= product_form.text_field :price_discounted, size: "5", class: 'product-price form-control' %></td>
      <td class="product-total"><%= (product.qty * product.price_discounted).round(4) %></td>
      <% end %>
    </tr>
    <% end %>
  </tbody>
  <tr>
    <td colspan="2" rowspan="4" align="center">
      <%= f.text_area :customer_notes, class: "form-control", rows: 5, placeholder: 'Customer Notes'%>
    </td>
    <td colspan="4" rowspan="4" align="center">
      <%= f.text_area :staff_notes, class: "form-control", rows: 5, placeholder: 'Staff Notes'%>
    </td>
    <td class="ProductCost" align="right">Subtotal (Inc. GST)</td>
    <td class="ProductTotal" align="right"><%= f.text_field :subtotal, readonly: true, class: "form-control" %></td>
  </tr>
  <tr>
    <td class="ProductCost" align="right">Discount Rate</td>
    <td class="ProductTotal" align="right"><%= f.text_field :discount_rate, class: "form-control" %></td>
  </tr>
  <tr>
    <td class="ProductCost" align="right">Discount</td>
    <td class="ProductTotal" align="right"><%= f.text_field :discount_amount, readonly: true, class: "form-control" %></td>
  </tr>
  <tr>
    <td class="ProductCost" align="right">Shipping</td>
    <td class="ProductTotal" align="right"><%= f.text_field :shipping_cost, class: "form-control" %></td>
  </tr>
  <tr>
    <td colspan="6" rowspan="2" align="center">
      <%= f.text_area :delivery_instruction, class: "form-control", rows: 5, placeholder: 'Delivery Instruction', class: "form-control" %>
    </td>
    <td class="ProductCost" align="right">GST</td>
    <td class="ProductTotal" align="right"><%= f.text_field :gst, readonly: true, class: "form-control" %></td>
  </tr>
  <tr>
    <td class="ProductCost" align="right">
      Grand Total
    </td>
    <td class="ProductTotal" align="right"><%= f.text_field :total_inc_tax, readonly: true, class: "form-control"%></td>
  </tr>
</table>
<div class="row">
  <div class="col">
    <%= link_to :cancel, {controller: 'order', action: 'all'}, class: "btn btn-warning"%>
    <%= submit_tag "save with new note", name: :new_note, class: 'btn btn-primary save active' %>
    <%= submit_tag "save", class: 'btn btn-primary save active' %>
    <%#= 
    button_tag(type: 'submit', class: 'btn btn-primary save active', value: 'new_note') do %>
      <!-- <div> Save & New Note </div> -->
    <%# end %>
    <!-- <button name="button" class="btn btn-primary disabled" disabled>Save & New Note</button> -->
    <%#= button_tag(type: 'submit', class: 'btn btn-success save active') do %>
      <!-- <div><%#= (@order.id.nil?) ? 'Create' : 'Save'%></div> -->
    <%# end %>
    <!-- <button name="button" class="btn btn-success disabled" disabled><%= (@order.id.nil?) ? 'Create' : 'Save'%></button> -->
  </div>
</div>

<!-- Number Calculation -->
<script type="text/javascript">
  var gst = parseFloat('<%= TaxPercentage.gst_percentage * 0.01%>');
  var wet = parseFloat('<%= TaxPercentage.wet_percentage * 0.01 %>');

  var last_products = $('#last_products');
  var street = $('#order_street');
  var city = $('#order_city');
  var state = $('#order_state');
  var postcode = $('#order_postcode');
  var country = $('#order_country');

  var billing_street = $('#order_customer_street');
  var billing_city = $('#order_customer_city');
  var billing_state = $('#order_customer_state');
  var billing_postcode = $('#order_customer_postcode');
  var billing_country = $('#order_customer_country');

  var last_order = $('.last_order');

  // Count the product numbers
  var product_count = $('.product-table tbody.product-list tr').length

  $('#order_customer_id').hide();

  // Customer Search
  $(document).on('railsAutocomplete.select', '#retail_customer_search', function(event, data){
    if ($('#customer_table').find('remove').length == 0) {
      $('.customer_autocomplete').html('<div class="input-group"><input type="text" name="customer" id="' + 
        data.item.id + '" class="form-control" value="' + data.item.value + 
        '" readonly="readonly"><div class="input-group-append"><span class="input-group-text" id="basic-addon1"><i class="far fa-trash-alt remove" title="remove"></i></span></div></div>');
      $('#order_customer_id').val(data.item.id);
      // In view/status
      // Update last products / last order and everything else
      var link = "/fetch_last_products?customer_id=" + data.item.id
      $.ajax({
          type: 'GET',
          url: link
      });

      $('.remove').click(function () {
        $('.customer_autocomplete').html(
          '<div class="input-group"><%= autocomplete_field_tag "name", "", autocomplete_customer_actual_name_activity_index_path, placeholder: "Search Customer", id: "retail_customer_search", class: "form-control" %><div class="input-group-append"><span class="input-group-text" id="basic-addon1"><i class="fas fa-user-plus"></i></span></div></div>');
        $('#order_customer_id').val('');
        $('.last-order-product-retail').remove();
        $('.last-order-td').remove();
      });
    }
  });

  // BEGIN: add product on autocomplete select
  $(document).on('railsAutocomplete.select', '#retail_product_search',function(event, data){
    product_count += 1;

    $('.product-table tbody.product-list').append([
      '<tr id="tr_'+ data.item.id +'">',
        '<td><input size="5" readonly="readonly" class="product-id form-control" type="text" value="' + 
          data.item.id +'" name="order[products['+ product_count +']][product_id]" id="order_products_'+ 
          product_count +'__product_id"></td>',
        '<td>'+ data.item.label +'</td>',
        '<td class="product-inventory">'+ data.item.inventory +'</td>',
        '<td><input size="5" readonly="readonly" class="product-luc form-control" type="text" value="' + 
          parseFloat(data.item.calculated_price) * (1+gst) + '" name="order[products[' + 
          product_count + ']][price_luc]" id="order_products_' + product_count + '__price_luc"></td>',

        '<td><input size="3" class="product-qty form-control" type="text" value="0" name="order[products[' + 
          product_count + ']][qty]" id="order_products_' + product_count + '__qty"></td>',

        '<td><div class="input-group"><input size="2" class="product-discount form-control" type="text" value="0" name="order[products[' + product_count + ']][discount]" id="order_products_' + 
          product_count + '__discount"  placeholder="Discount"><div class="input-group-append"><span class="input-group-text" id="basic-addon1">%</span></div></div></td>',
        
        '<td><input size="5" class="product-price form-control" type="text" value="' + 
          parseFloat(data.item.calculated_price) * (1 + gst) + '" name="order[products[' + 
          product_count + ']][price_discounted]" id="order_products_' + 
          product_count + '__price_discounted"></td>',

        '<td class="product-total">0.00</td>',
        '<td><i class="far fa-trash-alt remove_row" title="remove"></i></td>',
      '</tr>'
      ].join(''));
  });
  // END: add product on autocomplete select

  // BEGIN: add product on last ordered products click
  $(document).on('click', '.last-order-product-retail',function(){
    product_count += 1;

    $('.product-table tbody.product-list').append([
      '<tr id="tr_' + $(this).attr('product-id') + '">',
        '<td><input size="5" readonly="readonly" class="product-id form-control" type="text" value="'+ 
          $(this).attr('product-id') + '" name="order[products[' + product_count + 
          ']][product_id]" id="order_products_' + product_count + '__product_id"></td>',
        '<td>'+ $(this).attr('name') +'</td>',
        '<td class="product-inventory">' + $(this).attr('inventory') + '</td>',
        '<td><input size="5" readonly="readonly" class="product-luc form-control" type="text" value="' + 
          parseFloat($(this).attr('price')) / (1 + wet) * (1 + gst) + '" name="order[products[' + 
          product_count + ']][price_luc]" id="order_products_' + product_count + '__price_luc"></td>',
        '<td><input size="3" class="product-qty form-control" type="text" value="1" name="order[products[' + 
          product_count + ']][qty]" id="order_products_' + product_count + '__qty"></td>',
        
        '<td><div class="input-group"><input size="2" class="product-discount form-control" type="text" value="0" name="order[products[' + product_count + ']][discount]" id="order_products_' + product_count + '__discount"  placeholder="Discount"><div class="input-group-append"><span class="input-group-text" id="basic-addon1">%</span></div></div></td>',

        '<td><input size="5" class="product-price form-control" type="text" value="' + 
          parseFloat($(this).attr('price')) / (1 + wet) * (1+gst) + '" name="order[products[' + 
          product_count + ']][price_discounted]" id="order_products_' + product_count + 
          '__price_discounted"></td>',

        '<td class="product-total">0.00</td>',
        '<td><i class="far fa-trash-alt remove_row" title="remove"></i></td>',
      '</tr>'
    ].join(''));
  });
  // BEGIN: add product on last ordered products click

  var update_subtotal = function(){
    var total = 0;
    var discount = 0;
    $('.product-list tr').each(function(){
      total += parseFloat($(this).find('.product-total').html());
      discount += (parseFloat($(this).find('.product-luc').val()) - parseFloat($(this).find('.product-price').val())) *  parseInt($(this).find('.product-qty').val());
    });
    $('#order_subtotal').val(total.toFixed(4));

    order_discount = parseFloat($('#order_discount_rate').val()) * 0.01
    discount += (total * order_discount)
    shipping_cost = parseFloat($('#order_shipping_cost').val())
    if (isNaN(shipping_cost)) shipping_cost = 0;
    $('#order_gst').val((total*(1-order_discount)/11 + (shipping_cost)* gst).toFixed(4));
    $('#order_discount_amount').val(discount.toFixed(4));
    $('#order_total_inc_tax').val(((total *( 1 - order_discount) + shipping_cost + shipping_cost*gst)).toFixed(4));
    return total;
  }

  var product_change = function(column){
    qty = column.parent().parent().find('.product-qty').val();
    luc = column.parent().parent().find('.product-luc').val();
    price = column.parent().parent().find('.product-price').val();
    discount = 0;

    if(column.attr('class') == 'product-discount'){
      price = luc * (1 - column.val() * 0.01 );
      column.parent().parent().find('.product-price').val(price.toFixed(4));
    }else if (column.attr('class') == 'product-price') {
      discount = (1 - (column.val() / luc)) * 100 ;
      column.parent().parent().find('.product-discount').val(discount.toFixed(2));
    }
    column.parent().parent().find('.product-total').html((price * qty).toFixed(4));
    update_subtotal();
  };

  $(document).on('input', '.product-qty, .product-discount, .product-price', function(){
    product_change($(this));
  });
  $(document).on('input', '#order_discount_rate, #order_shipping_cost', function(){
    update_subtotal();
  });
  $(document).on('click', '.remove_row', function(){
    $(this).parent().parent().remove();
  });
</script>

<!-- Submit Tag -->
<script type="text/javascript">
  $('button.active').hide();

  var valid_check = function(){
    var customer_flag = $('tr input[name=customer]').size() > 0;
    alert(customer_flag);
    var product_flag = $('tbody.product-list tr').size() > 0;
    var shipping_address_flag = (($('input#order_street').val() != "") && ($('input#order_city').val() != "") && ($('input#order_postcode').val() != ""));
    var table_flag = $('table.product-table input:text').filter(function() { return (this.value == "" || this.value=="NaN"); }).size() == 0;

    if (customer_flag && product_flag && shipping_address_flag && table_flag){
      $('button.active').show();
      $('button.disabled').hide();
    }else{
      $('button.active').hide();
      $('button.disabled').show();
    };
  }

  $(document).on('input', valid_check);
  $(document).on('click', valid_check);
</script>
