<%= title "Customer Map" %>

<script src="//maps.google.com/maps/api/js?key=AIzaSyB1HFWQ1DigWTnXGn_ZaUOk-v8hgGF3moI"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>

<div class="container">
    <div class="row">
        <div class='col-md-8'>
            <div id="customer_location" style='width: 650px; height: 600px;'></div>
        </div>

        <%= form_tag({:action => "map"}, {:method => "get"}) do %>
        <div class="col-md-4">

          <li class="dropdown">
            <a class="" data-toggle="dropdown" href="#">Sales Executive</a>
              <ul class="dropdown-menu">
                <% @staff.each do |person| %>
                <li>
                  <%= check_box_tag 'selected_staff[]', person.id %>
                  <%= person.nickname %>
                  &nbsp;&nbsp;
                </li>
                <% end %>
              </ul>
          </li>

          <li class="dropdown">
            <a class="" data-toggle="dropdown" href="#">Customer Type</a>
              <ul class="dropdown-menu">
                <% @customer_type.each do |cust| %>
                <li>
                  <%= check_box_tag 'selected_cust_type[]', cust.id %>
                  <%= cust.name %>
                  &nbsp;&nbsp;
                </li>
                <% end %>
              </ul>
          </li>
          <%= submit_tag "Search", class: 'btn btn-primary' %>
          <%= link_to "Reset", {controller: "calendar", action: "map"}, class: "btn btn-primary" %>

        </div>
        <% end %>
    </div>
</div>

<script>
    var handler = Gmaps.build('Google');
    handler.buildMap({
        internal: {
            id: 'customer_location'
        }
    }, function () {
        var markers = handler.addMarkers(<%=raw @hash.to_json %>);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
    });

    $(function () {
        $('#due_timepicker').datetimepicker({
          format: 'DD/MM/YYYY',
          defaultDate: new Date(),
          sideBySide: true
        });
        var dt = new Date();
        dt.setMonth(dt.getMonth()-2);
        $('#start_timepicker').datetimepicker({
          format: 'DD/MM/YYYY',
          defaultDate: dt,
          sideBySide: true,
          useCurrent: false //Important! See issue #1075
        });

        $("#due_timepicker").on("dp.change", function (e) {
            $('#start_timepicker').data("DateTimePicker").maxdate(e.date);
        });
        $("#start_timepicker").on("dp.change", function (e) {
            $('#due_timepicker').data("DateTimePicker").minDate(e.date);
        });
    });
</script>
