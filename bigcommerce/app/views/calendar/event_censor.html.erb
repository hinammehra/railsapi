<%= title "Event From Calendars" %>
<div>
  <table id="event-table">
  <thead>
    <tr>
      <th>
        <li class="dropdown">
          <a class="" data-toggle="dropdown" href="#">Creator
            <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <% @staffs.each do |staff| %>
              <li class="staff-dropdown" id="staff-<%= staff.id%>">
                <%= staff.nickname %>
              </li>
              <% end %>
            </ul>
        </li>
      </th>
      <th>&nbsp;&nbsp;&nbsp;</th>
      <th>Summary</th>
      <th>Time</th>
      <th>&nbsp;&nbsp;&nbsp;</th>
      <th>Customer</th>
      <th>Method</th>
      <th>Subjects</th>
      <th>&nbsp;&nbsp;&nbsp;</th>
    </tr>
  </thead>
    <% @events.each do |event|%>
    	<%= form_tag({:action => "translate_events"}, {:method => "get"}) do %>
      <%= hidden_field_tag :event_id , event.id %>
      <%
        staff = @staff_calendars.select{|x| x.calendar_address == event.creator.email}.first
        response_staff = @staffs.select{|x| x.id == staff.staff_id }
      %>
      <tr class="google-event-line  staff-event-<%= (response_staff.nil? || response_staff.blank?) ? event.creator.email : response_staff.first.id.to_s%> ">
        <td><%= (response_staff.nil? || response_staff.blank?) ? event.creator.email : response_staff.first.nickname %></td>
        <td>&nbsp;&nbsp;&nbsp;</td>
        <td><%= event.summary.to_s%><br/><%= event.description.to_s %></td>
        <td><%= event.start.date_time.strftime("%m-%d %H:%M")%> --
            <%= event.end.date_time.strftime("%H:%M")%>
        </td>
        <td>&nbsp;&nbsp;&nbsp;</td>
        <%
          unless event.summary.nil?
            # loc = event.location.split(",").first.split.select{|x| (x.to_i.to_s.casecmp(x)<0) && !(["st","pl","street","St"].include?(x))}
            loc = event.summary.split(" ")
            customer_list = @customers.select{|x| Regexp.union(loc) === x.actual_name }
            customer_list = customer_list.sort_by! {|x| @jarow.getDistance(loc.join(" "), x.actual_name) }.reverse

            lead_list = @leads.select{|x| Regexp.union(loc) === x.actual_name }
            lead_list = lead_list.each {|x| x.actual_name = x.actual_name.to_s + ', (Lead)'}
            lead_list = lead_list.sort_by! {|x| @jarow.getDistance(loc.join(" "), x.actual_name) }.reverse
            customer_list = lead_list + customer_list
        %>
          <td><%= collection_select :customer, :customer, customer_list, ->(ob) {"#{ob.id}|#{ob.actual_name}"}, :actual_name, {:include_blank => "Select a Customer"} %></td>
        <%else%>
          <td></td>
        <%end%>
        <td><%= collection_select :method, :method, @methods, :method, :method, {:include_blank => "Select a Method", :selected => "Meeting"} %></td>
        <td><%= collection_select :subject, :subject, @subjects, :id, :subject, {:include_blank => "Select a Subject"} %></td>
        <td>
          <%= button_tag(type: 'submit', name: 'submit', class: "btn btn-default", value: 'confirm') do%>
            <span class="glyphicon glyphicon-plus"></span>
          <% end %>
          <%= button_tag(type: 'submit', name: 'submit', class: "btn btn-default", value: 'reject') do%>
            <span class="glyphicon glyphicon-remove"></span>
          <% end %>
          <%= link_to '<i class="glyphicon glyphicon-pencil" title="Create Lead"></i>'.html_safe, controller: "lead", action: "create_leads"%>
        </td>
      </tr>
      <% end %>
    <% end %>
  </table>
</div>

<script>
<% @staffs.each do |staff| %>
  $("#staff-<%= staff.id%>").click(function(){
    $(".google-event-line").hide();
    $(".staff-event-<%=staff.id%>").toggle();
  });
<% end %>
</script>
