<%= render "partials/paginate", objects: contacts %>


<table class = "table table-striped table-bordered table-hover table-responsive">
	<tr>
		<th id="contact_name_head">Name <%= render "partials/sort_arrows", order: 'order_by_name' %></th>
		<th>Top Task</th>
		<th>
			<li class="dropdown">
				<a class="" data-toggle="dropdown" href="#">Sales Rep
					<span class="caret"></span></a>
					<ul class="dropdown-menu">
						<% @staff_pair.values.uniq.each do |staff_id, staff_name| %>
						<li>
							<% if ((!@selected_staff.nil?)&&(@selected_staff.include? staff_id.to_s)) %>
								<%= check_box_tag 'selected_staff[]', staff_id, true %>
							<% else %>
								<%= check_box_tag 'selected_staff[]', staff_id %>
							<% end %>
							<%= staff_name %>
							&nbsp;&nbsp;
						</li>
						<% end %>
					</ul>
			</li>
		</th>
		<th>Outstanding <%= render "partials/sort_arrows", order: 'order_by_outstanding' %></th>
		<th>Overdue <%= render "partials/sort_arrows", order: 'order_by_overdue' %></th>
		<% @date = [Date.today,Date.strptime("#{@end_date}", '%Y-%m-%d')].min %>
		<% if ('monthly'.eql? @monthly) && (@date != Date.today)%>
			<th><%= @date.strftime("%B") %><%= render "partials/sort_arrows", order: "order_by_invoice|#{(@date - 1.month).to_date.beginning_of_month}|#{@date.to_date.end_of_month}" %>
				<br/>
				<%= check_box_tag 'selected_months[]', "#{(@date - 1.month).to_date.beginning_of_month}|#{@date.to_date.end_of_month}"%>
			</th>
		<% elsif%>
			<th>Current<%= render "partials/sort_arrows", order: "order_by_invoice|#{@date.to_date.beginning_of_month}|#{@date.to_date.end_of_month}" %>
				<br/>
				<%= check_box_tag 'selected_months[]', "#{@date.to_date.beginning_of_month}|#{@date.to_date.end_of_month}" %>
			</th>
		<% else %>
			<th>Current<%= render "partials/sort_arrows", order: "order_by_invoice|#{(@date - 15.days).to_date}|#{@date.to_date}" %>
				<br/>
				<%= check_box_tag 'selected_months[]', "#{(@date - 15.days).to_date}|#{@date.to_date}" %>
			</th>
		<% end %>

		<% for i in 1..4 %>
			<% if 'monthly'.eql? @monthly %>
				<th> <%= (@date - i.month).strftime("%B")%><%= render "partials/sort_arrows", order: "order_by_invoice|#{(@date - i.month).to_date.beginning_of_month}|#{(@date-i.month).to_date.end_of_month}" %>
					<br/>
					<%= check_box_tag 'selected_months[]', "#{(@date - i.month).to_date.beginning_of_month}|#{(@date-i.month).to_date.end_of_month}" %>
				</th>
			<% else %>
				<th><%= @date - (i*15).days %> - <%= @date - ((i+1)*15).days + 1.day %><%= render "partials/sort_arrows", order: "order_by_invoice|#{(@date - ((i+1)*15).days).to_date}|#{(@date - (i*15).days).to_date}" %>
					<br/>
					<%= check_box_tag 'selected_months[]', "#{(@date - ((i+1)*15).days).to_date}|#{(@date - (i*15).days).to_date}" %>
				</th>
			<% end %>
		<% end %>
		<th> Older
			<br/>
			<%= ('monthly'.eql? @monthly) ? (check_box_tag 'selected_months[]', "2000-01-01|#{(@date - 4.month).to_date.end_of_month}") : (check_box_tag 'selected_months[]', "2000-01-01|#{(@date - 60.days).to_date}") %>
		</th>
	</tr>

		<% contacts.each do |c| %>
			<% sum_of_amount = Hash.new%>
			<% sum_of_amount["invoice_date"] = Array.new(6){0}%>
			<% sum_of_amount["due_date"] = Array.new(6){0}%>

			<% invoices[c.id].each do |i| %>
				<% interval = ("monthly".eql? @monthly)? ((@date.year * 12 + @date.month) -  (i.date.to_date.year * 12 + i.date.to_date.month)) : ((@date.mjd - i.date.to_date.mjd) / 15)%>
				<% interval = interval > 5 ? 5 : interval %>
				<% sum_of_amount["invoice_date"][interval]+=i.amount_due%>
				<% interval = ("monthly".eql? @monthly)? ((@date.year * 12 + @date.month) -  (i.due_date.to_date.year * 12 + i.due_date.to_date.month)) : ((@date.mjd - i.due_date.to_date.mjd) / 15)%>
				<% interval = interval < 0 ? 0 : interval %>
				<% interval = interval > 5 ? 5 : interval %>
				<% sum_of_amount["due_date"][interval]+=i.amount_due%>
			<% end%>
	<tr>
		<td>
			<%= check_box_tag 'selected_contacts[]', c.skype_user_name, false, class: "contact_name_checkbox" if overdue_customer(c) > 0 %>
			<%= link_to c.name, controller: 'accounts', action: 'contact_invoices', contact_id: c.xero_contact_id, end_date: @date, monthly: @monthly %>
		</td>
		<% top_task = Task.select("tasks.id, tasks.subject_1, tasks.end_date").customer_tasks(c.skype_user_name).is_task.active_tasks.order(:end_date).first %>
			<% unless top_task.blank?%>
				<% task_week = top_task.end_date.strftime("%U")
						now_week = Time.now.strftime("%U")
						if task_week == now_week %>
							<td class="this_week">
				<%  elsif task_week > now_week %>
							<td class="next_week">
				<%  else %>
							<td class="last_week">
				<%  end %>
					<%= TaskSubject.find(top_task.subject_1).subject%>
			<% else %>
				<td>
			<% end %>
		</td>
		<td><%= @staff_pair[c.id].last %></td>
		<td class="num"><%= (outstanding_customer(c) == 0)? "-" : display_num(outstanding_customer(c))  %></td>
		<td class="num"><%= (overdue_customer(c) == 0)? "-" : display_num(overdue_customer(c)) %></td>
		<% sum_of_amount[date_column].each do |sum|%>
			<td class="num"><%= (sum == 0)? "-" : display_num(sum) %></td>
		<% end %>
	</tr>
	<% end %>

</table>

<span style="float:right;">
<%= paginate(contacts) %>
</span>
