<!-- edited by vchar on 20180807 -->
<!-- edited by vchar on 20180814 -->

<%= title @customer_name %>

<div class="row mb-3">
	<div class="col-12">
		<div class="card">
		  	<div class="card-header text-center h3 text-secondary">
				<%= @customer_name %>
				<p>
					<a href="http://maps.apple.com/?q=<%=@customer.actual_name%>&sll=<%=@customer.lat%>,<%=@customer.lng%>&z=10">
						<span class="badge badge-info mt-3">
							<%= @customer.address unless @customer.address.nil?%>
						</span>
					</a>
				</p>
				<%= link_to '<i class="far fa-edit"></i>'.html_safe, { action: 'edit', 
					customer_id: @customer_id, customer_name: @customer_name }, 
					title: 'Edit customer information' %>
				<%= link_to '<i class="fas fa-user-plus"></i>'.html_safe, { controller: 'contact', 
					action: 'create_contact', customer_id: @customer_id, 
					customer_name: @customer_name }, title: 'Add a new contact' %>
				<%= '<i class="fas fa-credit-card credit-expand" title="Show credit applications List">
					</i>'.html_safe if user_full_right(session[:authority]) %>
				<%= link_to '<i class="fas fa-list credit-expand"></i>'.html_safe, 
					{ action: 'top_products', customer_id: @customer_id, 
					customer_name: @customer_name }, title: "Top products list" %>
		  	</div>
	 	 	<div class="card-body">
	 	 		<div class="credit_list" style="display: none;"></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	// load credit list
	var credit_list = $('.credit_list');
	$('.credit-expand').click(function(){
		credit_list.toggle();
		if (credit_list.is(':visible')){
			var link = "/credit_list?customer_id=<%= @customer.id%>"
			$.ajax({
					type: 'GET',
					url: link,
					format: 'js'
			});
		}
	});
</script>

<div class="row mb-3">
	<!-- BEGIN: display customer summary header -->
	<div class="col-5">
		<%= render "customer_partials/summary_header", customer: @customer %>
	</div>
	<!-- END: display customer summary header -->


	<div class="col-7">
		<!-- BEGIN: display overdue and outstanding amount -->
		<div class="row">
			<div class="col">
				<% xero_contact = @customer.xero_contact %>
				<% 
					unless xero_contact.nil?
					overdue = overdue_customer(xero_contact)
					outstanding = outstanding_customer(xero_contact)
				%>
					<% unless overdue - Params::EPSILON < 0.00 %>
						<span class="badge badge-danger my-2">Overdue amount: <%= display_num(overdue) %></span>
					<% end %>
					<% unless outstanding - Params::EPSILON < 0.00 %>
						<span class="badge badge-primary my-2">Oustanding amount: <%= display_num(outstanding) %></span>

					<% end %>
				<%end%>
			</div>
		</div>
		<!-- END: display overdue and outstanding amount -->

		<!-- BEGIN: display customers map -->
		<div class="row">
			<!-- spot = GooglePlaces::Client.new('AIzaSyBvfTZH0XCVEJQTgR9QDYt18XIeV5MIkPI').spots_by_query(@customer.actual_name.to_s + ' ' + @customer.city.to_s).first if @customer.cust_type_id != 1 -->
			<% spot = nil %>
			<% unless spot.nil? %>
				<div class="col">
					<%= render 'lead_partials/lead_pictures', spot: spot, size: 400%>
				</div>
			<% end %>
			<div class="col">
				<script src="//maps.google.com/maps/api/js?key=AIzaSyB1HFWQ1DigWTnXGn_ZaUOk-v8hgGF3moI"></script>
				<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
				<div id="map" style='height: 360px;'></div>
			</div>
		</div>
		<!-- END: display customers map -->
	</div>	
</div>

<%= form_tag({:action => "summary" }, {:method => "get"}) do %>
	<%= render 'customer_partials/activity'%>
	<%= render "partials/overall_stats", sum_param: "$", supply_display_class: "none" %>
	<%= hidden_field_tag :customer_id, @customer_id %>
  	<%= hidden_field_tag :customer_name, @customer_name %>
<% end %>

<% unless @amount_due.nil?%>
	<%= render 'accounts_partials/account_stats', customer: @customer, amount_due: @amount_due%>
<% end %>

<%= render "partials/order", orders: @orders, display_class: "none", product_ids: nil %>

<!-- Map -->
<script type="text/javascript">
	var handler = Gmaps.build('Google');
	handler.buildMap({
			internal: {
					id: 'map'
			}
	}, function () {
		<% unless @customer.lat.nil?%>
			markers = handler.addMarkers([
				{
					"lat": '<%= @customer.lat %>',
					"lng": '<%= @customer.lng %>',
					"picture": {
						"url": '<%= image_path('map_icons/townhouse.png')%>',
						"width":  30,
						"height": 30
					}
				}
			]);
			<% customers = Customer.near([@customer.lat, @customer.lng], 1, units: :km).where('id != ?', @customer.id).select{|x| x} %>
			<% leads = CustomerLead.near([@customer.lat, @customer.lng], 1, units: :km) %>
			<% customer_markers, lead_markers, restaurant_markers =  marks_by_distance(customers, leads, []) %>
			customer_markers = handler.addMarkers(<%=raw customer_markers.to_json%>);
      lead_markers = handler.addMarkers(<%= raw lead_markers.to_json%>);

			handler.bounds.extendWith(markers);
			handler.fitMapToBounds();
			handler.getMap().setZoom(15);
		<% end %>
	});
</script>

<!-- Hide Stats -->
<script>
	// $('.activity-section').hide();
	<% if current_user_sales?(session[:authority]) %>
		$('.accounts-stats-section').hide();
	<% end %>
</script>
