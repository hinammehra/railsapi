<!-- edited by vchar on 20180821 -->

<%= title @product_name %>

<div class="row mb-3">
	<div class="col-12">
		<div class="card">
		  	<div class="card-header text-center h3 text-secondary">
				<%= @product_name %>

				<p class="h5 mt-2">
					<%= link_to 'Edit', { controller: 'product', action: 'edit' }, 
						class: "btn btn-outline-primary text-info",
						product_id: @product_id if @transform_column == 'product_id' %>
					<%= link_to "Orders of the product", { controller: 'order', action: 'for_product', 
						product_id: @product_id, product_name: @product_name, 
						transform_column: @transform_column },
						class: "btn btn-outline-primary text-info" %>

					<!-- Allocate Products -->
					<% if @transform_column!='product_no_vintage_id' && 
						user_full_right(session[:authority]) %>
						<%= link_to "Allocate", { controller: 'product', 
							action: 'allocate', product_id: @product_id, 
							product_name: @product_name, 
							transform_column: @transform_column, 
							total_stock: @total_stock }, 
							class: "btn btn-outline-primary text-info" %>
					<% end %>
				</p>
		  	</div>
	 	 	<div class="card-body text-center">
				<p class="h5 mt-2">
					<span class="badge badge-primary">
						Product Stock: <%= @total_stock %>,
					</span> 
					<span class="badge badge-primary">
						Pending Stock: <%= @customer_pendings.values().sum %> 
					</span> <br/>
					<span class="badge badge-primary">
						Total Stock (WS + Retail + Pending) : <%= @total_stock_no_ws %>
					</span>
				</p>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-12">
	 	<!-- Overall Stats Display -->
		<%= form_tag({:action => "summary" }, {:method => "get"}) do %>
			<%= render "partials/overall_stats", sum_param: "Qty", supply_display_class: "" %>
		   	<%= hidden_field_tag :product_id, @product_id %>
		   	<%= hidden_field_tag :product_name, @product_name %>
		   	<%= hidden_field_tag :total_stock, @total_stock %>
		   	<%= hidden_field_tag :transform_column, @transform_column %>
		<% end %>
	</div>
</div>

<div class="row">
	<div class="col-12">
		<!-- BEGIN: product statistics with filter -->
		<%= form_tag({action: 'product_inventory_overwrite'}, {method: 'get'}) do %>
		  	<table class="table table-striped table-bordered table-hover table-responsive w-100 d-block d-table">
				<tr>
					<th>Product ID</th>
					<th>Product Name</th>
					<th>Inventory</th>
				</tr>
				<% product_rights = !Staff.find(session[:user_id]).product_rights.zero?%>
				<% @products.each do |product| %>
					<tr>
						<td><%= link_to product.id, controller: 'product', action: 'summary', pending_stock: 0, product_id: product.id, product_name: product.name, total_stock: product.inventory, transform_column: 'product_id' %></td>
						<td>
							<%= link_to product.name, controller: 'product', action: 'summary', pending_stock: 0, product_id: product.id, product_name: product.name, total_stock: product.inventory, transform_column: 'product_id' %>
							<% if user_full_right%>
								<%= 'Sales after 30th: ' + Order.joins(:order_products).valid_order.where(
									"order_products.product_id = #{product.id} AND date_created > '2017-10-29'"
									).sum('order_products.qty').to_s %>
							<% end %>
						</td>
						<td>
							<%= product_rights ? text_field_tag("product[#{product.id}]", product.inventory,
							placeholder: 'Inventory', class: 'form-control')  : product.inventory %>
						</td>
					</tr>
				<% end %>

				<% if product_rights %>
					<tr>
						<td colspan="3" align="center">
							<%= submit_tag "update", class: 'btn btn-warning' %>
						</td>
					</tr>
				<% end %>
		  	</table>
  		<% end %>
  		<!-- END: product statistics with filter -->
	</div>
</div>

<div class="row">
	<div class="col-12">
		<!-- BEGIN: list top customers filter -->
		<%= form_tag({:action => "summary"}, {:method => "get", 
			class: "form-inline justify-content-center mt-3"}) do %>

		   	<%= render "partials/cust_style_filter" %>
		   	<%= render "partials/staff_filter" %>

		   	<%= hidden_field_tag :product_id, @product_id %>
		   	<%= hidden_field_tag :product_name, @product_name %>
		   	<%= hidden_field_tag :transform_column, @transform_column %>

		   	<%= submit_tag "filter", class: 'btn btn-primary' %>
		<% end %>
		<!-- END: list top customers filter -->
	</div>
</div>

<table class = "table table-striped table-bordered table-hover table-responsive w-100 d-block d-table">
	<tr class="info">
		<th>Customer <%= render "partials/sort_arrows", order: 'order_by_name' %></th>
		<th>Staff <%= render "partials/sort_arrows", order: 'order_by_staff' %></th>
		<th>Channel <%= render "partials/sort_arrows", order: 'order_by_style' %></th>
		<th>Pending Stock</th>
		<% @time_periods.each do |t| %>
			<th><%= t %><%= render "partials/sort_arrows", order: t %></th>
		<% end %>
	</tr>

	<% @customer_ids.each do |id| %>
	<tr>
		<td><%= link_to customer_name(@top_customers[id]), controller: 'customer', action: 'summary_with_product', product_id: @product_id, product_name: @product_name, customer_id: id, customer_name: customer_name(@top_customers[id]), transform_column: @transform_column %></td>
		<td><%= staff_nickname(@top_customers[id]) %></td>
		<td><%= customer_style_name(@top_customers[id]) %></td>
		<td><%= @customer_pendings[id] %></td>
		<% @time_periods.each do |t| %>
			<td><%= exists_in_h(@top_customers_timeperiod_h[t], id) %></td>
		<% end %>
	</tr>
	<% end %>

</table>
